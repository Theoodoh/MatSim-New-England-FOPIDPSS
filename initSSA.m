%% this m-file perfrmes small-signal analysis
initDyn


% x = [25.5553       4.5786      11.2183     0.616726      7.95753      10.5173      26.4487      8.11822      15.1329     0.960126     0.640149     0.312237    0.0276501     0.250375    0.0232875     0.351989     0.267168     0.113598     0.492587     0.649117     0.050838     0.670707     0.181732     0.682334     0.115486     0.344237     0.453384      0.58295     0.135012     0.188542    0.0783471     0.351877     0.298987     0.137776     0.365092     0.320927    0.0501965     0.436608     0.181161     0.331189     0.303194     0.238242     0.455443     0.255275     0.686137      2.35316      0.77127      3.61206      6.46898      16.0843       6.9683      9.31154      7.10716      1.29823      10.0813      3.38015      11.6223      9.39579      8.05614      10.2357     0.919669      18.6537      17.3969      12.6273      3.70277      14.7861     0.204853      5.53346      6.53487       7.2886      5.90075      1.73054     0.355887     0.396343      1.28264     0.504183      0.76454     0.455877      1.41741      1.01987      1.05853    0.0660379      1.83275     0.449456      1.68156     0.248741      1.30345     0.754161      0.33027     0.375176];
% x = [25.5393      6.14685     0.471032      11.2541       23.899      6.25238      6.27412      11.3337      19.0002     0.380761    0.0212834     0.188745     0.643492     0.133433    0.0365018     0.578049     0.256038     0.491589     0.276857     0.693553     0.374511     0.181831     0.176622     0.277574    0.0965388     0.358616     0.639928     0.290008    0.0283759     0.354422     0.343667     0.321998     0.106475      0.55992     0.241756     0.380511    0.0225312     0.430045    0.0502271     0.220098     0.557079      0.65316     0.284964     0.215665     0.139944      12.1725      3.97096      12.0226     0.228937      7.34476      7.24369       1.8802      4.07531      8.86952      5.26527      2.35149      5.76762      7.96111      5.73086      8.77243      5.50247      1.11329      14.5577      9.20355      4.41539       4.0837        3.308      4.37899      9.08362      6.31568       7.7817      3.02184     0.955092     0.259033     0.999582     0.428087     0.726432     0.491011      1.21348     0.268159     0.443012     0.067772      1.00415     0.554846     0.518247     0.830155     0.293332     0.631157      1.50723     0.191732];
% x = [18.4458       33.114      2.10645      5.36324      2.03437      8.67513      6.52912      11.2442      15.5378     0.321226     0.328097     0.468074    0.0809894     0.193741     0.177294     0.187911    0.0299023     0.212128     0.793634     0.186134     0.241466     0.308888     0.617585     0.508468    0.0218251     0.664292     0.084249     0.681142     0.193977     0.159691      0.04262     0.480844     0.770097     0.225968     0.199498     0.278267     0.158156     0.256728     0.163375     0.324362     0.111853     0.102289     0.226265    0.0846506    0.0273645     0.546001      4.70949      3.87961      1.34064      2.88735      7.47652       5.7136      10.5641      3.30296    0.0534036      5.67774      5.49427       5.4597      4.11053      2.80464      8.17023      7.96508      10.1554      8.25183      5.30158      2.39487      1.33585      5.99663      2.44264      3.04454       2.9259      13.9711     0.773717     0.325727     0.758121      0.22471     0.673834     0.451475     0.966182     0.310444      1.14223     0.378666     0.546809     0.487299      1.00772      1.16644      1.02026     0.600329     0.847568     0.608038];
% x = [27.8977      19.3608      21.7947      30.3574      14.2611      46.1219      14.9769      21.5761      43.2439    0.0180443    0.0312971     0.058381     0.943706    0.0409791    0.0342819     0.190107     0.116006   0.00589149    0.0367996     0.709619     0.734445    0.0181562   0.00470456     0.765869     0.171366     0.028267    0.0222738     0.208846    0.0904482    0.0186847    0.0366917      0.25914     0.209634    0.0220733   0.00417594     0.464578     0.556199    0.0408635    0.0158976      0.27357    0.0312618    0.0230843     0.020459      0.67551      1.45339     0.108281     0.838114    0.0697626      9.41601   0.00517323      2.28508     0.526679      1.65079      14.0044      1.28055      5.36873      5.92465      4.06589      3.09877      16.1742      2.91734       1.8212      15.9282      7.24259      4.10971      7.20567      2.62958      7.54278      17.4642       14.545      4.15577      14.0493     0.833908     0.956241      1.22328     0.714894     0.477605    0.0785626     0.784622     0.288644      1.18132     0.821225      1.93355      0.32987      1.52417     0.603099      1.47118     0.665422     0.896958      0.01429];
% x = [24.6433      24.5261      42.3637      22.3371      42.6166      26.8035      41.1976      34.2395      18.5935    0.0471018    0.0355042     0.295121     0.193481    0.0416002   0.00970187     0.603603      1.08611    0.0481556    0.0190956     0.917724      1.59738    0.0165389     0.011108      0.37996      1.43018    0.0233616    0.0229357     0.545406       1.0435   0.00957944   0.00785747     0.361712    0.0240825    0.0355861   0.00816497     0.635661       1.8169    0.0369098     0.010046     0.658712      0.96157    0.0463826    0.0326913     0.808463      0.10016      11.4378      6.15286     0.865558      13.7579        11.86      4.32342      18.7124      9.78291      13.8267      12.2771      8.41129      14.4911      2.50746      10.0266      6.89133      1.48758      2.18816      5.08136     0.701396     0.720537      11.8971      10.2714       18.461      6.15927      12.7899      6.76093      15.2361      1.83357      1.51452     0.850059     0.822763      1.98658     0.870805      1.93483     0.714982      1.55759     0.489213       1.7939      0.85082      1.26967     0.742249      1.62433     0.304481      1.51672     0.930961];
% x = [29.7321      10.7054      26.7651      10.8242      11.9473      28.9623        22.88       11.125      26.6872    0.0170018    0.0201193     0.910013      1.01548    0.0153879   8.0945e-05     0.661163     0.740979   0.00902378    0.0234151     0.553565     0.175912    0.0203816     0.039156     0.382058      1.59172    0.0397582   0.00585464     0.170388      1.38204    0.0439184    0.0351957     0.475814       0.2181    0.0478163   0.00820258     0.228932      1.75951    0.0150601     0.014119     0.074863       1.7409    0.0214033    0.0282439     0.300633     0.784226      6.73357      11.4131      17.7189      6.64405      16.3959      6.39805      1.15861      5.28018      6.72041      5.06778     0.650168      1.73044      17.2375     0.335235      8.07697      2.23589      2.51461        6.567      0.05406      6.11101      8.71834      14.9716     0.624947      16.5558      17.3239      6.21756      15.9703       1.7271     0.744203      1.07542     0.824887      1.23269     0.645894       1.8095      1.66722     0.366156      0.29181      1.41244     0.782287     0.224548     0.741839      1.28703     0.458612      1.73151      1.24095];
% x = [13.9737      23.2319      21.4058      16.7153      16.0763      22.0331      27.9827      15.9733      25.9542     0.037974    0.0037968     0.996551       1.3625    0.0430095    0.0115913     0.944492      1.70171    0.0279062   0.00773021     0.654822     0.469983    0.0419968   0.00237976     0.629494     0.345962    0.0383687    0.0109908     0.842706      1.24129    0.0490311   0.00149813     0.301059       1.3056    0.0364693    0.0148979     0.901976      1.08847    0.0307745     0.003333     0.606571       0.3781    0.0429278    0.0403201     0.264559     0.789501      4.33603      8.68477      8.52743      13.4546      9.12857      12.7133      1.84151       7.1704      13.8114      8.70509      1.89815       14.916      6.80669      4.74602      10.6379       12.611      11.7218      13.1277      9.51066       2.1509       12.318      1.23828      0.60299      13.1134      14.5147      7.90704      9.67872      0.48702     0.868104     0.532423     0.642007     0.743455     0.443309     0.346802     0.339408     0.728452     0.731973     0.862051     0.207936     0.765517     0.478238     0.283483     0.124014     0.878098    0.0712815];
% x = [11.3985      18.2865      16.6983      14.9377      25.4866      15.2407       23.864      29.0494      12.3415    0.0452098     0.017776     0.689776     0.867175    0.0279706    0.0274015     0.203652  3.55629e-07    0.0440731    0.0230694     0.699841     0.537662    0.0422759      0.01104     0.566402      1.10351    0.0452426   0.00116239     0.362971      1.47994    0.0340036    0.0214355     0.551891      1.61037    0.0272089     0.021572     0.456663      1.00125    0.0311827    0.0106342     0.637217     0.595685    0.0221994    0.0341555     0.430408      1.57231      17.2427      5.03547      15.8416      5.75538      2.26765      11.9147       10.526       8.0898      9.42954      9.05216      8.74247       17.203      4.48687      3.58512      6.98775      2.49717      3.16168      7.68805      4.14057      1.04785      8.88266      3.43631      4.27266      9.74035      5.71946      9.26885      11.8821     0.843729     0.607867     0.349751     0.286626     0.994406     0.356986     0.838512     0.319906     0.436689     0.130193     0.248691     0.630367     0.614249     0.692668     0.815761     0.791954     0.611615     0.198108];
% x = [36.1404      18.9702      12.6487       18.317      19.7624      11.0402      23.7507      17.1579      36.3334    0.0330192   0.00552832       0.7556     0.220345    0.0467606  0.000826747     0.383326     0.810101    0.0316693    0.0170345     0.785639     0.297375    0.0328055   0.00274015     0.726217      1.76294    0.0196413    0.0132506    0.0833472     0.829653    0.0457443    0.0338473     0.223802     0.338242    0.0499873   0.00306836     0.231957     0.799431    0.0243958    0.0222236     0.474865     0.233793     0.029311    0.0331797     0.404927     0.609433      4.60725       6.3568      9.13283       3.0835      7.92546      18.0039       1.7761       5.8672     0.121223      5.07245      7.02365      7.43014      3.18022     0.042857      9.53599      7.03573      10.8581      17.2124      7.06856      5.42995      9.75562      16.8345     0.168478      14.7121      6.55742      12.2558      1.93251     0.777869     0.616435     0.729345     0.484781      1.47647      1.00916      1.47253     0.752663     0.706893     0.457607      1.46395      0.68125     0.769509     0.543954      1.21825     0.415839      1.44048     0.108366];
% x = [21.2392      31.0903      42.9201       12.435       30.852      22.1619      11.2287      29.8966      29.2683    0.0360898   0.00458096     0.923621     0.983635    0.0494992   0.00912572     0.374505      0.24846    0.0327527   0.00182305     0.429952     0.684376    0.0171212    0.0359842     0.203594      1.80044    0.0348113   0.00577021     0.355095     0.506671    0.0364785    0.0258622     0.549898    0.0789687    0.0349157     0.028749     0.438754     0.954368    0.0345797     0.012635     0.839203      1.42148    0.0470834    0.0356116     0.430378   0.00296375      11.2371      3.79737      2.61246     0.139289      11.7927      7.91322      5.54388       2.3288      12.2162      1.37092       7.5609      9.52676     0.583897      8.15778      4.71463      3.63544      2.06668      2.54202      1.86316      2.99904      8.77181      16.5902      17.8369      14.9694      13.5936      2.61831      9.69369     0.832144     0.805516     0.829085     0.713609       1.0769      0.42757     0.512561     0.167704     0.709275     0.939409       1.0494     0.338896       1.4826     0.279983      1.49472     0.351291      1.30856     0.636684];
x = [24.3077      22.5937      16.7982      12.7335       13.511      17.6083      32.6707      22.4168      17.4627     0.031465    0.0033679     0.722968      1.29695    0.0417097   0.00425413     0.967369      1.76884    0.0464116   0.00913967     0.274424     0.567329    0.0277921   0.00112349     0.292003      1.74237    0.0192565    0.0146006     0.182864  0.000831857     0.044226   0.00933087     0.305255      1.23061    0.0407206    0.0259284     0.276631      1.71617    0.0403803  0.000173005     0.580093      1.16708    0.0394319    0.0107959     0.454186     0.478177      3.36379       9.6024       19.474      17.9973        10.83      10.2909      4.65959      10.3749      18.8089      2.75612      6.35511      10.2032      9.78219       5.0608       1.6127      9.46732      7.79402       5.7604      1.23005      3.09449      17.1753      4.53845      9.05801      17.8885       14.108      8.20367      7.80167     0.962998     0.853345     0.257811       0.8236     0.638849     0.510842     0.337859      0.57646     0.936534     0.767009      0.60627     0.524616     0.569678     0.564402     0.366847     0.472155      0.47148     0.464048];

Tw = 10;
KG1 = x(1);
T11 = x(10);
T12 = x(11);
T13 = x(12);
T14 = x(13);
P1 = x(46);
I1 = x(47);
D1 = x(48);
L1 = x(73);
M1 = x(74);
Kpss1 = KG1*T11*T13/(T12*T14);


KG3 = x(2);
T31 = x(14);
T32 = x(15);
T33 = x(16);
T34 = x(17);
P3 = x(49);
I3 = x(50);
D3 = x(51);
L3 = x(75);
M3 = x(76);
Kpss3 =  KG3*T31*T33/(T32*T34);


KG4 = x(3);
T41 = x(18);
T42 = x(19);
T43 = x(20);
T44 = x(21);
P4 = x(52);
I4 = x(53);
D4 = x(54);
L4 = x(77);
M4 = x(78);
Kpss4 =  KG4*T41*T43/(T42*T44);


KG5 = x(4);
T51 = x(22);
T52 = x(23);
T53 = x(24);
T54 = x(25);
P5 = x(55);
I5 = x(56);
D5 = x(57);
L5 = x(79);
M5 = x(80);
Kpss5 =  KG5*T51*T53/(T52*T54);


KG6 = x(5);
T61 = x(26);
T62 = x(27);
T63 = x(28);
T64 = x(29);
P6 = x(58);
I6 = x(59);
D6 = x(60);
L6 = x(81);
M6 = x(82);
Kpss6 =  KG6*T61*T63/(T62*T64);


KG7 = x(6);
T71 = x(30);
T72 = x(31);
T73 = x(32);
T74 = x(33);
P7 = x(61);
I7 = x(62);
D7 = x(63);
L7 = x(83);
M7 = x(84);
Kpss7 =  KG7*T71*T73/(T72*T74);


KG8 = x(7);
T81 = x(34);
T82 = x(35);
T83 = x(36);
T84 = x(37);
P8 = x(64);
I8 = x(65);
D8 = x(66);
L8 = x(85);
M8 = x(86);
Kpss8 =  KG8*T81*T83/(T82*T84);


KG9 = x(8);
T91 = x(38);
T92 = x(39);
T93 = x(40);
T94 = x(41);
P9 = x(67);
I9 = x(68);
D9 = x(69);
L9 = x(87);
M9 = x(88);
Kpss9 =  KG9*T91*T93/(T92*T94);


KG10 = x(9);
T101 = x(42);
T102 = x(43);
T103 = x(44);
T104 = x(45);
P10 = x(70);
I10= x(71);
D10= x(72);
L10 = x(89);
M10 = x(90);
Kpss10 =  KG10*T101*T103/(T102*T104);

%% Linearize Power System
% f11=linmod('sys10m');
f11=linmod('sys10m_pss');

% dx/dt = A.x + B.u
% y = C.x + D.u

Asys = f11.a ;
Bsys = f11.b ;
Csys = f11.c ;
Dsys = f11.d ;

%% Calculate Eigenvalues
egs = eig(Asys)
Ns = length(egs);
Damp=-real(egs)./sqrt(real(egs).^2+imag(egs).^2)
freq=abs(imag(egs))/(2*pi)

%% calculae Participation Factors
[Vs,D_eig] = eig(Asys);
Ws=inv(Vs);
for i=1:Ns
    for k=1:Ns
        Pfact1(k,i)=abs(Vs(k,i))*abs(Ws(i,k));
    end
end

for i=1:Ns
     Pfact(i,:)=Pfact1(i,:)/sum(Pfact1(i,:));
end

for i=1:Ns
    [s_val s_idx]=sort(Pfact(:,i),'descend');
    mod_idx(i,:)=s_idx(1:4)';
    pf_fact(i,:)=s_val(1:4)';
end
mod_idx;
pf_fact;

idx_zero = find(abs(egs)<1e-6)
EG_new = egs;
EG_new(idx_zero)=[];

idx_EMs = find(max(real(EG_new)))
EMs = EG_new(idx_EMs)
